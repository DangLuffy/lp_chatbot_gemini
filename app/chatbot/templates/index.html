<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LP Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f3f4f6;
            /* Tailwind gray-100 */
            margin: 0;
            padding: 1rem;
        }

        #chat-container {
            width: 100%;
            max-width: 600px;
            background-color: white;
            border-radius: 0.5rem;
            /* Tailwind rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            /* Tailwind shadow-md */
            display: flex;
            flex-direction: column;
            height: 80vh;
            /* Chiều cao của container chat */
            max-height: 700px;
        }

        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            /* Tailwind p-4 */
            border-bottom: 1px solid #e5e7eb;
            /* Tailwind border-gray-200 */
        }

        .message {
            margin-bottom: 0.75rem;
            /* Tailwind mb-3 */
            padding: 0.5rem 0.75rem;
            /* Tailwind p-2 px-3 */
            border-radius: 0.375rem;
            /* Tailwind rounded-md */
            max-width: 80%;
            word-wrap: break-word;
        }

        .user-message {
            background-color: #3b82f6;
            /* Tailwind bg-blue-500 */
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }

        .bot-message {
            background-color: #e5e7eb;
            /* Tailwind bg-gray-200 */
            color: #1f2937;
            /* Tailwind text-gray-800 */
            align-self: flex-start;
            margin-right: auto;
            white-space: pre-wrap;
            /* Để giữ các dấu xuống dòng từ bot */
        }

        #chat-form {
            display: flex;
            padding: 1rem;
            /* Tailwind p-4 */
        }

        #message-input {
            flex-grow: 1;
            border: 1px solid #d1d5db;
            /* Tailwind border-gray-300 */
            padding: 0.5rem 0.75rem;
            /* Tailwind p-2 px-3 */
            border-radius: 0.375rem;
            /* Tailwind rounded-md */
            margin-right: 0.5rem;
            /* Tailwind mr-2 */
        }

        #send-button {
            background-color: #10b981;
            /* Tailwind bg-emerald-500 */
            color: white;
            padding: 0.5rem 1rem;
            /* Tailwind p-2 px-4 */
            border: none;
            border-radius: 0.375rem;
            /* Tailwind rounded-md */
            cursor: pointer;
        }

        #send-button:hover {
            background-color: #059669;
            /* Tailwind bg-emerald-600 */
        }

        h1 {
            color: #111827;
            /* Tailwind text-gray-900 */
            margin-bottom: 1.5rem;
            /* Tailwind mb-6 */
        }
    </style>
</head>

<body>
    <h1 class="text-3xl font-bold text-center">Chatbot Giải Quy Hoạch Tuyến Tính</h1>
    <div id="chat-container">
        <div id="chat-messages">
            <div class="message bot-message">
                Xin chào! Hãy nhập bài toán quy hoạch tuyến tính của bạn. Ví dụ: "Maximize 3x1 + 2x2 subject to x1+x2
                <=10" </div>
            </div>
            <form id="chat-form">
                <input type="text" id="message-input" placeholder="Nhập bài toán của bạn..." autocomplete="off">
                <button type="submit" id="send-button">Gửi</button>
            </form>
        </div>

        <script>
            const chatMessages = document.getElementById('chat-messages');
            const chatForm = document.getElementById('chat-form');
            const messageInput = document.getElementById('message-input');

            chatForm.addEventListener('submit', async function (event) {
                event.preventDefault(); // Ngăn form submit theo cách truyền thống

                const userMessageText = messageInput.value.trim();
                if (!userMessageText) return;

                appendMessage(userMessageText, 'user');
                messageInput.value = ''; // Xóa input sau khi gửi

                // Hiển thị "Bot đang soạn..." (tùy chọn)
                const typingIndicator = appendMessage('Bot đang soạn...', 'bot', true);

                try {
                    const formData = new FormData();
                    formData.append('message', userMessageText);

                    // Gửi tin nhắn đến backend
                    // URL này cần khớp với prefix và endpoint trong web_routes.py
                    // Ví dụ, nếu web_routes.py được include với prefix "/chatbotui" trong main.py
                    // thì URL sẽ là "/chatbotui/send_message"
                    const response = await fetch('/send_message', { // Điều chỉnh URL này nếu cần
                        method: 'POST',
                        body: formData
                    });

                    // Xóa chỉ báo "Bot đang soạn..."
                    if (typingIndicator) {
                        chatMessages.removeChild(typingIndicator);
                    }

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ detail: "Lỗi không xác định từ server." }));
                        const errorMsg = errorData.detail || `Lỗi: ${response.status} ${response.statusText}`;
                        appendMessage(`Lỗi: ${errorMsg}`, 'bot');
                        console.error('Error sending message:', errorMsg, errorData);
                        return;
                    }

                    const data = await response.json();
                    appendMessage(data.bot_response, 'bot');

                } catch (error) {
                    if (typingIndicator) {
                        chatMessages.removeChild(typingIndicator);
                    }
                    appendMessage('Lỗi kết nối tới server. Vui lòng thử lại.', 'bot');
                    console.error('Network error:', error);
                }
            });

            function appendMessage(text, sender, isTyping = false) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message');
                if (sender === 'user') {
                    messageDiv.classList.add('user-message');
                } else {
                    messageDiv.classList.add('bot-message');
                }
                messageDiv.textContent = text;
                chatMessages.appendChild(messageDiv);

                // Cuộn xuống tin nhắn mới nhất
                chatMessages.scrollTop = chatMessages.scrollHeight;
                return isTyping ? messageDiv : null;
            }
        </script>
</body>

</html>